<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta property="og:title" content="深入浅出分析Starcoin的架构设计"><meta property="og:description" content="Starcoin使用增强的PoW共识，是首个使用Move作为智能合约语言的无许可公链，也是把DAO链上治理做得最彻底的公链"><meta property="og:type" content="article"><meta property="og:url" content="/blog/starcoin_arch/"><meta property="article:published_time" content="2021-11-15T00:00:00+00:00"><meta property="article:modified_time" content="2021-11-15T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="深入浅出分析Starcoin的架构设计"><meta name=twitter:description content="Starcoin使用增强的PoW共识，是首个使用Move作为智能合约语言的无许可公链，也是把DAO链上治理做得最彻底的公链"><meta name=generator content="Hugo 0.62.0"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"深入浅出分析Starcoin的架构设计","url":"\/blog\/starcoin_arch\/","wordCount":"3952","datePublished":"2021-11-15T00:00:00+00:00","dateModified":"2021-11-15T00:00:00+00:00","author":{"@type":"Person","name":"邓启明"},"keywords":"starcoin, blockchain, blog","description":"Starcoin使用增强的PoW共识，是首个使用Move作为智能合约语言的无许可公链，也是把DAO链上治理做得最彻底的公链"}</script><link rel=canonical href=../../blog/starcoin_arch/><title>深入浅出分析Starcoin的架构设计 | Westar</title><link rel=stylesheet href=../../css/amazeui.min.css><link rel=stylesheet href=../../css/style.css></head><body><header class="am-topbar am-topbar-fixed-top header-light" style=background:#fff><div class=am-container-big><h1 class=am-topbar-brand><a href=../../ alt="westar logo" class=logo-a><img src=../../images/logo_dark.png alt></a></h1><button class="am-topbar-btn am-topbar-toggle am-btn am-btn-sm am-btn-secondary am-show-sm-only" data-am-collapse="{target: '#collapse-head'}"><span class=am-sr-only>导航切换</span> <span class=am-icon-bars></span></button><div class="am-collapse am-topbar-collapse" id=collapse-head><div class=am-topbar-right><ul class="am-nav am-nav-pills am-topbar-nav"><li><a href=../../blog/>博客</a></li><li class=am-dropdown data-am-dropdown><a class=am-dropdown-toggle data-am-dropdown-toggle href=javascript:void(0);>项目</a><ul class=am-dropdown-content><li><a href=https://starcoin.org><div class=nav-dropdown-item><div class=left><div class="icon nav-icon-sirius"></div></div><div class=right><h3 class=am-gallery-title>Starcoin Blockchain</h3><div class=section-faq-desc>新⼀代分层的智能合约和分布式⾦融⽹络</div></div></div></a></li><li><a href=../../projects/sirius/><div class=nav-dropdown-item><div class=left><div class="icon nav-icon-sirius"></div></div><div class=right><h3 class=am-gallery-title>Sirius Protocol</h3><div class=section-faq-desc>去中心化、安全、多方、及时的二层支付协议</div></div></div></a></li><li><a href=../../projects/stargate/><div class=nav-dropdown-item><div class=left><div class="icon nav-icon-sirius"></div></div><div class=right><h3 class=am-gallery-title>Stargate Protocol</h3><div class=section-faq-desc>Starcoin 的二层协议实现</div></div></div></a></li><li><a href=../../projects/thor/><div class=nav-dropdown-item><div class=left><div class="icon nav-icon-sirius"></div></div><div class=right><h3 class=am-gallery-title>Thor Protocol</h3><div class=section-faq-desc>闪电网络上的智能合约和仲裁服务</div></div></div></a></li></ul></li><li><a href=../../about/>关于我们</a></li><li><a href=../../blog/westar_careers/>加入我们</a></li></ul></div></div></div></header><div class=news-container-detail><div class=am-container><div class=blog-main><article data-am-widget=paragraph class="am-paragraph am-paragraph-default" data-am-paragraph="{ tableScrollable: true, pureview: true }"><header><h2 class="news-title about-color blog-post-title" dir=auto>深入浅出分析Starcoin的架构设计</h2><p class=blog-post-meta><time datetime=2021-11-15T00:00:00Z>Mon Nov 15, 2021</time>
by
邓启明
in
<i class="fa fa-folder" aria-hidden=true></i>&nbsp;<a href=../../categories/blog rel="category tag">blog</a>
<i class="fa fa-tag" aria-hidden=true></i>&nbsp;<a href=../../tags/starcoin rel=tag>starcoin</a>, <a href=../../tags/blockchain rel=tag>blockchain</a></p></header><h2 id=starcoin>Starcoin的架构</h2><p>2021年5月18日，Starcoin，新⼀代分层的智能合约和分布式⾦融⽹络，正式启动主网。Starcoin使用增强的PoW共识，是首个使用Move作为智能合约语言的无许可公链，也是把DAO链上治理做得最彻底的公链。Westar实验室作为开源技术的爱好者，有幸接触了一些Starcoin的设计和实现，为开源社区贡献了一点点力量。这里，我们从技术的角度，介绍一下Starcoin。</p><p>Starcoin是一个比较庞大的系统，我们先从宏观上了解一下Starcoin的整体架构。如图所示，Starcoin包含非常多的组件，例如Chain、Sync、TxPool、Stdlib等等。从整体上来说，Starcoin包括两大部分：</p><ul><li>链，Rust，图中未划线部分</li><li>合约，Move，图中划线部分</li></ul><p>我们可以简单的将「链」和「合约」通过编程语言区分。链相关的逻辑是通过Rust实现的，而合约则通过Move表达。虽然逻辑上将Starcoin分成了「链」和「合约」两部分，但是「链」和「合约」又起到相互支撑、相互促进的作用。「链」是「合约」的基础，为合约提供运行环境。而「合约」又为「链」提供养分，表达链的一些核心状态，例如区块奖励等等。所以，「链」和「合约」是一个相互作用的统一整体。</p><p><img src=images/starcoin_arch.jpg alt=starcoin_arch></p><h3 id=starcoinservice>Starcoin的核心Service</h3><p>前面我们从宏观的角度，了解了一下Starcoin的整体架构，接下来，我们分别介绍一下Starcoin的「链」包含的核心组件、服务和功能。</p><p>Starcoin借鉴微服务的思想，将不同的模块进行拆分，再通过服务的方式，将不同功能组织起来，以节点的方式统一提供服务。Starcoin使用了Rust的Actix框架，设计了一套功能完善的service-registy系统，包括服务注册、服务状态检查、服务关闭等能力，能非常方便地管理服务的生命周期。同时，为服务之间通信设计了一套Bus协议，将服务解耦。如图所示，service-registy模块中的RegistyService是所有其他服务的基础服务。</p><p><img src=images/starcoin_services.jpg alt=starcoin_services></p><ul><li>node模块中的NodeService表示节点服务，代表了一个Starcoin的节点，主要用于初始化节点需要的服务，是Starcoin节点启动的入口；</li><li>network模块的NetworkActorService表示网络服务，用于处理Starcoin网络消息，例如建立节点连接、广播区块、同步交易等等；</li><li>rpc模块的RpcService表示Rpc服务，用于管理ipc、tcp、http和websocket请求，包括管理对外的接口、限流等功能；</li><li>txpool模块的TxPoolService表示交易池，用于管理本地的交易，是普通用户使用最多的服务之一；</li><li>sync模块的TxnSyncService表示交易同步服务，用于从Starcoin网络的其他节点同步交易；</li><li>sync模块的SyncService表示区块同步服务，用于从Starcoin网络的其他节点同步区块；</li><li>chain模块的ChainReaderService表示读取链服务，通常用于查询区块、状态等操作；</li><li>storage的Storage表示链的存储，所有链相关的数据，都存储在Storage中；</li><li>stratum模块的StratumService是矿池服务，实现了矿池协议，用于跟矿机打交道；</li><li>miner模块的MinerService是挖矿任务管理服务，用于组装区块，生成挖矿任务；</li><li>sync模块中的BlockConnectorService表示连接区块的服务，将网络同步过来的区块、网络广播过来的、本地节点挖的区块连接到链上；</li><li>sync模块中的WriteBlockChainService表示区块的写服务，验证区块、更新区块和状态，维护最新的链状态；</li></ul><p>以上是Starcoin比较核心和重要的Service，还有一些其他的Service这里没有介绍。</p><h2 id=starcoinstorage>Starcoin的Storage</h2><p>前面介绍了Starcoin的核心服务，所有的服务协作的结果是将数据存储起来，并且保证所有分布式节点的状态最终一致，所以，我们再深入介绍一下Starcoin的Storage相关的内容。</p><p>Starcoin的数据保存在Storage中，在介绍Storage之前，我们先来简单了解一下Starcoin两个非常特别的核心数据结构：</p><ul><li>双MerkleAccumulator</li><li>GlobalStateTree，双层结构的三个Tree</li></ul><h3 id=merkleaccumulator>双MerkleAccumulator</h3><p>MerkleAccumulator，如图所示，是Starcoin一个非常核心的数据结构，用于提供区块和交易的证明。MerkleAccumulator的特点是叶子节点可以从左到右不断增累加，然后构建成一个树形的MerkleAccumulator，最后将Root节点的哈希保存到区块中。使用MerkleAccumulator的好处是可以非常轻松地证明一个区块或者交易是否在链上，例如，图中叶子节点B的Proof是CAD。Starcoin巧妙地设计了两个MerkleAccumulator，分别为区块和交易提供证明，对应BlockHeader的block_accumulator_root和txn_accumulator_root，这就是Starcoin的“双MerkleAccumulator”。</p><p><img src=images/starcoin_merkle_accumulator.png alt=starcoin_merkle_accumulator></p><h3 id=globalstatetree>GlobalStateTree</h3><p>Starcoin的GlobalStateTree设计上也很有意思，由双层结构的三个Tree构成，如图所示：</p><ul><li>上层AccountTree的Root是BlockHeader的state_root</li><li>上层AccountTree的叶子节点映射到下层Tree的ResourceRoot和CodeRoot</li><li>下层StateTree的叶子节点映射到Account的Data区数据</li><li>下层CodeTree的叶子节点映射到Account的Code区数据</li></ul><p><img src=images/starcoin_state_tree.png alt=starcoin_state_tree></p><p>双MerkleAccumulator和GlobalStateTree的数据最终也会保存到Storage和StateDB中。</p><h3 id=storage>Storage</h3><p>Starcoin的Storage使用了Key-Value的RocksDB，存储了所有的区块、交易和用户状态等数据，如图所示，总共15个ColumnFamily（ID都表示Hash）：</p><ul><li>ChainInfo：保存链的master分支的Head Block等节点启动数据</li><li>Block：保存Block的ID与Block的映射关系</li><li>BlockHeader：保存Block的ID与BlockHeader的映射关系</li><li>BlockBody：保存Block的ID与BlockBody的映射关系</li><li>BlockInfo：保存Block的ID与BlockInfo的映射关系</li><li>BlockTransactions：保存Block的ID与Transaction的ID的映射关系</li><li>BlockTransactionInfos：保存Block的ID与TransactionInfo的ID的映射关系</li><li>FailedBlock：保存校验失败的Block</li><li>Transaction：保存Transaction的ID与Transaction的映射关系</li><li>TransactionInfo：保存Transaction的ID与TransactionInfo的映射关系</li><li>TransactionInfoHash：保存TransactionInfo的ID与Transaction的ID的映射关系</li><li>ContractEvent：保存TransactionInfo的ID与Event的映射关系</li><li>AccumulatorNodeBlock：保存AccumulatorNode的ID与AccumulatorNode的映射关系，属于Block的MerkleAccumulator的数据</li><li>AccumulatorNodeTransaction：保存AccumulatorNode的ID与AccumulatorNode的映射关系，属于Transaction的MerkleAccumulator的数据</li><li>StateNode：保存StateNode的ID与StateNode的映射关系，属于GlobalStateTree的数据</li></ul><p><img src=images/starcoin_storage.jpg alt=starcoin_storage></p><h2 id=move>Move</h2><p>前面介绍了Starcoin的Service和Storage，这两部分内容都属于「链」，接下来，我们介绍一下「合约」。</p><p>Starcoin使用Move作为智能合约语言。Move最大的特点有两个：</p><ul><li>面向资源编程，安全可靠</li><li>面向泛型编程，灵活可扩展</li></ul><p>从技术的角度分析，Move跟Solidity对比，除了上面2个大的区别，还有很多优点，主要如下：</p><ul><li>Ability特性，是Move的安全基石，Solidity没有</li><li>强大的模块化，Solidity跨合约只能通过Interface调用</li><li>纯静态调用，安全可靠，Solidity的动态调用导致很多大的安全漏洞</li><li>更丰富的函数可见性</li><li>可跨Module访问Struct类型，Solidity跨Contract只能使用基本类型</li><li>完善的测试体系，Move有非常完善的UnitTest和FunctionalTest</li><li>形式化验证，Solidity的形式化验证还处于初期探索阶段，不可用，基本上等于没有</li><li>轻松构建复杂系统，Solidity很难写万行代码以上级别的系统</li></ul><p>Move还有很多其他的优点，可以说，Move是智能合约的一次革命。所以，Starcoin选择Move作为智能合约语言。在Starcoin的生态中，已经有很多优秀的Move项目在落地，如图所示：</p><ul><li>DAO</li><li>Bridge</li><li>Swap</li><li>NFT</li><li>Oracle</li><li>Lending</li><li>StableCoin</li><li>IDO</li><li>INO</li><li>GmeFi</li><li>其他</li></ul><p><img src=images/starcoin_move_defi.jpg alt=starcoin_move_defi></p><h2 id=heading>最后</h2><p>不管是从链的角度，还是从合约的角度，Starcoin在设计上有很多有意思的地方。Westar实验室深入到Starcoin的源码，从技术的角度对Starcoin的进行解读，更多针对Starcoin的源码解读将逐步更新，欢迎大家关注。</p><hr><footer><section><h4>Share</h4><nav class="am-nav sharing-icons"><a class=am-nav-item href="https://www.facebook.com/sharer/sharer.php?u=%2fblog%2fstarcoin_arch%2f" title="Share on Facebook"><span class=am-icon-facebook-square aria-hidden=true></span></a><a class=am-nav-item href="https://www.linkedin.com/shareArticle?mini=true&url=%2fblog%2fstarcoin_arch%2f" title="Share on LinkedIn"><span class=am-icon-linkedin-square aria-hidden=true></span></a><a class=am-nav-item href="https://twitter.com/intent/tweet?url=%2fblog%2fstarcoin_arch%2f&text=%e6%b7%b1%e5%85%a5%e6%b5%85%e5%87%ba%e5%88%86%e6%9e%90Starcoin%e7%9a%84%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1" title="Tweet this"><span class=am-icon-twitter-square></span></a><a class=am-nav-item href="http://service.weibo.com/share/share.php?url=%2fblog%2fstarcoin_arch%2f&title=%e6%b7%b1%e5%85%a5%e6%b5%85%e5%87%ba%e5%88%86%e6%9e%90Starcoin%e7%9a%84%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1" title="Share to weibo"><span class=am-icon-weibo></span></a></nav></section></footer></article></div></div></div><footer class="footer footer-light"><div class=footer-logo><img src=../../images/footer_logo_dark.png width=50% height=50% alt></div><p class=foolter-slogo>关注我们，追踪项目最新状态</p><div class=foolter-follow><ul><li><a href=https://github.com/westarlabs/><img src=../../images/github_dark.png alt></a></li></ul></div><p>Copyright © <a href=../../ target=_blank>Westar</a> 2018-2021</p></footer><script src=https://cdn.bootcss.com/mermaid/8.4.7/mermaid.min.js></script><script src=../../js/zepto.min.js></script><script src=../../js/amazeui.min.js></script><script>window.onload=function(){mermaid.init(undefined,".language-mermaid");};</script><script>$(function(){$(window).scroll(function(){var top=$(window).scrollTop();if(top>120){$("#header").css({"background":"#110651"})}else{$("#header").css({"background-color":"rgba(0,0,0,0)"})}});function winResize(){var w=$(window).width();var h=$(window).height();$("#section-one").css({"height":h,"width":w});var p=h/w
if(p>=0.58){$(".section-one-bg").css({"background-size":"auto 100%"})}else{$(".section-one-bg").css({"background-size":"100% auto"})}}
winResize();$(window).resize(function(){winResize();});var faqLenth=$(".faq-index").length;for(var i=0;i<faqLenth;i++){$(".faq-index").eq(i).html(i+1)}})</script></body></html>