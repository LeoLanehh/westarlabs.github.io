<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta property="og:title" content="Elary 协议解读"><meta property="og:description" content="Erlay 是优化比特币 p2p 网络中交易转发的一个协议，其优化了带宽占用和网络传输的效率。"><meta property="og:type" content="article"><meta property="og:url" content="/blog/erlay/"><meta property="article:published_time" content="2020-01-21T00:00:00+00:00"><meta property="article:modified_time" content="2020-01-21T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Elary 协议解读"><meta name=twitter:description content="Erlay 是优化比特币 p2p 网络中交易转发的一个协议，其优化了带宽占用和网络传输的效率。"><meta name=generator content="Hugo 0.62.0"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Elary 协议解读","url":"\/blog\/erlay\/","wordCount":"1427","datePublished":"2020-01-21T00:00:00+00:00","dateModified":"2020-01-21T00:00:00+00:00","author":{"@type":"Person","name":"fikgol"},"keywords":"transaction relay, bandwidth efficient, blockchain, bitcoin, blog, elary","description":"Erlay 是优化比特币 p2p 网络中交易转发的一个协议，其优化了带宽占用和网络传输的效率。"}</script><link rel=canonical href=../../blog/erlay/><title>Elary 协议解读 | Westar</title><link rel=stylesheet href=../../css/amazeui.min.css><link rel=stylesheet href=../../css/style.css></head><body><header class="am-topbar am-topbar-fixed-top header-light" style=background:#fff><div class=am-container-big><h1 class=am-topbar-brand><a href=../../ alt="westar logo" class=logo-a><img src=../../images/logo_dark.png alt></a></h1><button class="am-topbar-btn am-topbar-toggle am-btn am-btn-sm am-btn-secondary am-show-sm-only" data-am-collapse="{target: '#collapse-head'}"><span class=am-sr-only>导航切换</span> <span class=am-icon-bars></span></button><div class="am-collapse am-topbar-collapse" id=collapse-head><div class=am-topbar-right><ul class="am-nav am-nav-pills am-topbar-nav"><li><a href=../../blog/>博客</a></li><li class=am-dropdown data-am-dropdown><a class=am-dropdown-toggle data-am-dropdown-toggle href=javascript:void(0);>项目</a><ul class=am-dropdown-content><li><a href=../../projects/sirius/><div class=nav-dropdown-item><div class=left><div class="icon nav-icon-sirius"></div></div><div class=right><h3 class=am-gallery-title>Sirius Protocol</h3><div class=section-faq-desc>去中心化、安全、多方、及时的二层支付协议</div></div></div></a></li><li><a href=../../projects/stargate/><div class=nav-dropdown-item><div class=left><div class="icon nav-icon-sirius"></div></div><div class=right><h3 class=am-gallery-title>Stargate Protocol</h3><div class=section-faq-desc>Starcoin 的二层协议实现</div></div></div></a></li><li><a href=../../projects/thor/><div class=nav-dropdown-item><div class=left><div class="icon nav-icon-sirius"></div></div><div class=right><h3 class=am-gallery-title>Thor Protocol</h3><div class=section-faq-desc>闪电网络上的智能合约和仲裁服务</div></div></div></a></li></ul></li><li><a href=../../about/>关于我们</a></li></ul></div></div></div></header><div class=news-container-detail><div class=am-container><div class=blog-main><article data-am-widget=paragraph class="am-paragraph am-paragraph-default" data-am-paragraph="{ tableScrollable: true, pureview: true }"><header><h2 class="news-title about-color blog-post-title" dir=auto>Elary 协议解读</h2><p class=blog-post-meta><time datetime=2020-01-21T00:00:00Z>Tue Jan 21, 2020</time>
by
fikgol
in
<i class="fa fa-folder" aria-hidden=true></i>&nbsp;<a href=../../categories/blog rel="category tag">blog</a>
<i class="fa fa-tag" aria-hidden=true></i>&nbsp;<a href=../../tags/elary rel=tag>elary</a>, <a href=../../tags/blockchain rel=tag>blockchain</a></p></header><p><strong><em>从本质上来看，这是一个在点对点网络中如何使得2个节点的数据更高效的同步为一致的问题。</em></strong></p><p>目前运营一个比特币节点所消耗总带宽的一半，仅用于广播交易。与区块的广播不同，
交易的广播在以往的工作中很少受到关注。原始的比特币 p2p 网络中
广播交易使用的是简单的 flooding （洪泛）策略。</p><p>本文介绍一种新的交易广播协议 Erlay，其可以减少 40% 的带宽消耗，而且
在节点连接数增加时，可以使带宽的增长按照常数级的方式增长，而不是现在
的线性增长。Erlay 协议的提议目前已经提交到比特币社区，未来很有可能被
引入到比特币协议升级中。</p><h2 id=heading>问题</h2><p>我们先来看看现在比特币协议中，一个 transaction 的生命周期是怎样的。</p><p>Erlay 协议主要讨论的是图中第二个方块中所描述的交易广播策略。不涉及到交易打包进
块之后区块的广播策略。</p><p>由图可见，一个交易被广播到某个节点后，又会继续被广播到所有它所连接的其他节点上。
那么一个交易就会被广播很多次，这样的策略是比较浪费带宽的。一个交易在 2 个节点间的传播如下图所示，</p><p>节点会把交易的哈希值放在 INV message 中用以询问另一节点是否有该交易, 如果没有，则调用 GETDATA 获取交易。</p><h2 id=erlay->Erlay 协议设计</h2><p>那么如何高效的找出 2 个节点 Alice 和 Bob 之间交易集合的差异，然后进行传输？</p><p>Erlay 中，节点之间进行交易核对(reconciliation) 通过如下办法，首先计算出一个
由交易集合经过 pinsketch 算法计算得出的草图(sketch)。草图有如下的性质：</p><ul><li>草图有一个预先确定的容量，当 sketches 中的元素数量不超过容量时，可以把整个集合恢复。</li><li>两个集合之间的差集的 sketch，可以从 2 个集合所构造的 sketch 进行 xor 运算得到
的结果中得到恢复。</li></ul><p><strong>所以，可以把节点中所有的交易都编码到 sketch 中，然后对2个节点的 sketch 进行 xor
操作得到差集的草图。只要差集的大小 &lt;= sketch 的容量，我们就能恢复出所有差集。
因此，还需要估算2个节点之间交易集合差集的大小。</strong></p><blockquote><p>定义:</p><ul><li>D: 2个集合的差集大小</li><li>d: 对 D 的 估算</li><li>q: 用来计算 d 的参数</li></ul></blockquote><p>那么令 <code>d = abs(|A| − |B|) + q * min(|A|, |B|) + c</code></p><p>首先两个集合求差集的结果是不小于集合大小的差值的，再把较小集合乘以 q 作为一个因子加上，c = 1 以防止:
<code>|a| = |B|</code> 和 <code>q * min(|a|, |B|) = 0 时 d = 0</code></p><p>如何计算q的值呢？ 初始轮，设置 q = 0，随后每一轮，用 D 来更新 q 的值:</p><p><code>q = (D − abs(|A| − |B|)) / min(|A|, |B|)</code></p><p>这样做是基于一个假设：网络中每个节点的 q 值是一个常量。</p><p>那么有了对差集大小的估算，2 个 transactions 集合的核对协议如下</p><p><img src=images/reconciliation_protocol.png alt=image-3></p><ol><li><p>Alice 把集合大小 |A| 和 q 发送给 Bob 。</p></li><li><p>Bob 根据 |A|,|B|, q 计算出 d , 然后计算草图 sketch(B, b) 并发送给 Alice 。</p></li><li><p>Alice 计算自己的草图 sketch(A, b), 然后对 2 个草图进行 xor 运算。
此刻有 2 种情况，d 的估算可用，则根据 diff hash 的集合 调用 GETDATA 获取差异的交易。</p></li><li><p>如果 d 的估算不可用，则会采用二分策略重新计算差集</p><p><code>diff1 = sketch(B/2, d), sketch(A/2, d)</code></p><p><code>diff2 = sketch(B-B/2, d), sketch(A-A/2, d)</code></p><p>即 Alice, Bob 对一半的元素进行草图的 xor 运算，然后再对另外一半进行 xor 运算。
2 个 diff 的结果即为总的交易差集。如果 diff1 或者 diff2 计算失败了，则回退到
比特币的原始 tx relay 协议。</p></li></ol><p>注意到步骤 4 还有一个更直观的办法是重新估算一个更大的 d 值，然后 Bob 重新计算
sketch(B, b)，再传给Alice。这样也是可行的，但之前传输的 sketch 就无效了，这种策
略是比较低效的。</p><p>而用二分策略的好处是，可以复用之前的 sketch, Bob 只要再把 sketch(B/2, b)
传输给Alice, 那么 Alice 就能算出</p><p><code>sketch(B-B/2, b) = sketch(B, b) xor sketch(B/2, b)</code></p><p>比特币网络中上述3种可能状态的实验占比为：</p><p>也就是说有 <code>96% + 4% * 93% = 99.72%</code> 的交易通过 erlay 的协议进行广播。
只有 0.28% 的交易会退回到 flooding</p><h2 id=heading-1>总结</h2><p>本文先介绍了原始的 transaction relay 协议 flooding, 然后介绍了 Erlay 的核心协议：如何把 2 集合编码到长度小于其差集大小的序列中，并恢复其差集，
以及估算 2 个集合差集大小的协议。</p><h2 id=heading-2>参考</h2><ol><li><p><a href=https://arxiv.org/abs/1905.10518>Bandwidth-Efficient Transaction Relay for Bitcoin</a></p></li><li><p><a href=https://github.com/sipa/minisketch/blob/master/doc/math.md>The mathematics of Minisketch sketches</a></p></li></ol><hr><footer><section><h4>Share</h4><nav class="am-nav sharing-icons"><a class=am-nav-item href="https://www.facebook.com/sharer/sharer.php?u=%2fblog%2ferlay%2f" title="Share on Facebook"><span class=am-icon-facebook-square aria-hidden=true></span></a><a class=am-nav-item href="https://www.linkedin.com/shareArticle?mini=true&url=%2fblog%2ferlay%2f" title="Share on LinkedIn"><span class=am-icon-linkedin-square aria-hidden=true></span></a><a class=am-nav-item href="https://twitter.com/intent/tweet?url=%2fblog%2ferlay%2f&text=Elary%20%e5%8d%8f%e8%ae%ae%e8%a7%a3%e8%af%bb" title="Tweet this"><span class=am-icon-twitter-square></span></a><a class=am-nav-item href="http://service.weibo.com/share/share.php?url=%2fblog%2ferlay%2f&title=Elary%20%e5%8d%8f%e8%ae%ae%e8%a7%a3%e8%af%bb" title="Share to weibo"><span class=am-icon-weibo></span></a></nav></section></footer></article></div></div></div><footer class="footer footer-light"><div class=footer-logo><img src=../../images/footer_logo_dark.png width=50% height=50% alt></div><p class=foolter-slogo>关注我们，追踪项目最新状态</p><div class=foolter-follow><ul><li><a href=https://github.com/westarlabs/><img src=../../images/github_dark.png alt></a></li></ul></div><p>Copyright © <a href=../../ target=_blank>Westar</a> 2018-2019</p></footer><script src=https://cdn.bootcss.com/mermaid/8.4.7/mermaid.min.js></script><script src=../../js/zepto.min.js></script><script src=../../js/amazeui.min.js></script><script>window.onload=function(){mermaid.init(undefined,".language-mermaid");};</script><script>$(function(){$(window).scroll(function(){var top=$(window).scrollTop();if(top>120){$("#header").css({"background":"#110651"})}else{$("#header").css({"background-color":"rgba(0,0,0,0)"})}});function winResize(){var w=$(window).width();var h=$(window).height();$("#section-one").css({"height":h,"width":w});var p=h/w
if(p>=0.58){$(".section-one-bg").css({"background-size":"auto 100%"})}else{$(".section-one-bg").css({"background-size":"100% auto"})}}
winResize();$(window).resize(function(){winResize();});var faqLenth=$(".faq-index").length;for(var i=0;i<faqLenth;i++){$(".faq-index").eq(i).html(i+1)}})</script></body></html>